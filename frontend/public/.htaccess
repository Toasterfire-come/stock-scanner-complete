<IfModule mod_rewrite.c>
  RewriteEngine On
  # If the request is for an existing file or directory, serve it
  RewriteCond %{REQUEST_FILENAME} -f [OR]
  RewriteCond %{REQUEST_FILENAME} -d
  RewriteRule ^ - [L]

  # React Router: send everything else to index.html
  RewriteRule ^ index.html [L]
</IfModule>

<IfModule mod_headers.c>
  Header set X-Frame-Options "DENY"
  Header set X-Content-Type-Options "nosniff"
  Header set X-XSS-Protection "1; mode=block"
  Header set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# SPA .htaccess for React app in document root

Options -MultiViews

<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /

  # Serve existing files and directories
  RewriteCond %{REQUEST_FILENAME} -f [OR]
  RewriteCond %{REQUEST_FILENAME} -d
  RewriteRule ^ - [L]

  # Do not rewrite API or backend routes (handled by backend service/domain)
  RewriteRule ^(api|revenue)(/.*)? - [R=404,L]

  # SPA fallback to index.html
  RewriteRule . index.html [L]
</IfModule>

# Fallback for SPA routes (Apache 2.4+)
FallbackResource /index.html

DirectoryIndex index.html

# Security headers and service worker scope
<IfModule mod_headers.c>
  Header set X-Frame-Options "DENY"
  Header set X-Content-Type-Options "nosniff"
  Header set X-XSS-Protection "1; mode=block"
  Header set Referrer-Policy "strict-origin-when-cross-origin"
  Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains" env=HTTPS

  <Files "sw.js">
    Header set Service-Worker-Allowed "/"
  </Files>
</IfModule>

# Caching for static assets; no cache for HTML
<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresByType text/html "access plus 0 seconds"
  ExpiresByType application/javascript "access plus 1 year"
  ExpiresByType text/css "access plus 1 year"
  ExpiresByType image/avif "access plus 1 year"
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType image/png "access plus 1 year"
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType font/woff2 "access plus 1 year"
</IfModule>

# MIME types for modern assets
<IfModule mod_mime.c>
  AddType image/avif .avif
  AddType image/webp .webp
  AddType font/woff2 .woff2
  AddType application/manifest+json .webmanifest
</IfModule>

# Content Security Policy (deliver via headers, not meta)
# Note: 'frame-ancestors' must be sent as a header to be respected
<IfModule mod_headers.c>
  Header always set Content-Security-Policy "default-src 'self'; base-uri 'self'; form-action 'self'; frame-ancestors 'none'; connect-src 'self' https://api.retailtradescanner.com https://www.paypal.com https://*.paypal.com https://o.sentry.io https://ingest.sentry.io https://plausible.io https://events.plausible.io https://fonts.googleapis.com https://fonts.gstatic.com https://query1.finance.yahoo.com https://query2.finance.yahoo.com; script-src 'self' https://www.paypal.com https://www.paypalobjects.com https://plausible.io; img-src 'self' data: https:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; frame-src https://www.paypal.com https://*.paypal.com"
</IfModule>

# Force HTTPS
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteCond %{HTTPS} !=on
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</IfModule>

# Compression (Brotli preferred, then Deflate)
<IfModule mod_brotli.c>
  BrotliCompressionQuality 5
  AddOutputFilterByType BROTLI_COMPRESS text/html text/plain text/xml text/css text/javascript application/javascript application/json application/xml image/svg+xml
</IfModule>
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json application/xml image/svg+xml
</IfModule>

# Caching headers
<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresByType text/html                      "access plus 1h"
  ExpiresByType text/css                       "access plus 7d"
  ExpiresByType application/javascript         "access plus 7d"
  ExpiresByType text/javascript                "access plus 7d"
  ExpiresByType image/svg+xml                  "access plus 30d"
  ExpiresByType image/png                      "access plus 30d"
  ExpiresByType image/jpeg                     "access plus 30d"
  ExpiresByType image/webp                     "access plus 30d"
  ExpiresByType application/json               "access plus 1h"
  ExpiresDefault                               "access plus 1h"
</IfModule>

# Security headers (complement to app)
<IfModule mod_headers.c>
  Header set X-Frame-Options "SAMEORIGIN"
  Header set X-Content-Type-Options "nosniff"
  Header set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# Serve offline page for true 404s (keeps SPA fallback returning 200)
ErrorDocument 404 /offline.html