{% extends 'base.html' %}

{% block title %}Revenue Analytics | Stock Scanner API{% endblock %}

{% block extra_css %}
<style>
    .analytics-dashboard { display: grid; gap: 2rem; }
    .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.25rem; margin-bottom: 1.5rem; }
    .metric-card { background: var(--bg-white); padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow-md); border: 1px solid var(--border-light); text-align: center; }
    .metric-value { font-size: 2rem; font-weight: 800; color: var(--secondary-blue); margin-bottom: 0.25rem; }
    .metric-label { color: var(--text-secondary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .metric-change.positive { color: var(--accent-green); }
    .metric-change.negative { color: var(--accent-red); }

    .charts-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); gap: 1.25rem; margin-top: 1.25rem; }
    .chart-container { background: var(--bg-white); padding: 1.25rem; border-radius: var(--border-radius); box-shadow: var(--shadow-md); border: 1px solid var(--border-light); }

    .api-response { background: var(--bg-light); border: 1px solid var(--border-light); border-radius: var(--border-radius-sm); padding: 1rem; margin-top: 1.25rem; }
    .response-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-light); }
    .response-data { background: var(--bg-dark); color: var(--text-dark); padding: 1rem; border-radius: var(--border-radius-sm); font-family: var(--font-mono, 'Monaco', 'Menlo', 'Ubuntu Mono', monospace); font-size: 0.9rem; overflow-x: auto; max-height: 400px; overflow-y: auto; border: 1px solid var(--border-light); }

    .loading { text-align: center; padding: 2rem; color: var(--text-secondary); }
    .error { background: var(--error-bg); color: var(--error-text); padding: 1rem; border-radius: var(--border-radius-sm); border: 1px solid var(--error-border); }
</style>
{% endblock %}

{% block content %}
<div class="analytics-dashboard">
    <div class="card">
        <h1 style="margin-bottom: 0.5rem; color: var(--text-primary);">Revenue Analytics Dashboard</h1>
        <p style="color: var(--text-secondary); margin-bottom: 1.25rem;">
            Real-time revenue metrics and subscription analytics for Stock Scanner API
        </p>
        <div style="display: flex; gap: 0.75rem; margin-bottom: 1.25rem; flex-wrap: wrap;">
            <button class="btn" onclick="loadAnalytics()">Refresh Data</button>
            <button class="btn btn-secondary" onclick="loadAnalytics('2025-07')">July 2025</button>
            <button class="btn btn-secondary" onclick="loadAnalytics('2025-06')">June 2025</button>
            <a href="/revenue/revenue-analytics/?format=json" class="btn btn-secondary">View JSON</a>
        </div>
    </div>

    <div id="analytics-content">
        <div class="loading">
            <div style="font-size: 1.25rem; font-weight: 800; margin-bottom: 0.75rem; color: var(--text-secondary);">Loading</div>
            <p>Loading revenue analytics...</p>
        </div>
    </div>
</div>

<script>
let currentData = null;
function loadAnalytics(monthYear = null) {
    const contentDiv = document.getElementById('analytics-content');
    contentDiv.innerHTML = `
        <div class="loading">
            <div style="font-size: 1.25rem; font-weight: 800; margin-bottom: 0.75rem; color: var(--text-secondary);">Loading</div>
            <p>Loading analytics data...</p>
        </div>
    `;
    const url = monthYear ? `/revenue/revenue-analytics/${monthYear}/` : '/revenue/revenue-analytics/';
    fetch(url, { headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }})
    .then(response => response.json())
    .then(data => { currentData = data; if (data.success) { displayAnalytics(data.data); } else { displayError(data.error || 'Failed to load analytics'); } })
    .catch(error => { console.error('Error loading analytics:', error); displayError('Network error loading analytics'); });
}
function displayAnalytics(analytics) {
    const contentDiv = document.getElementById('analytics-content');
    const html = `
        <div class="metrics-grid">
            <div class="metric-card"><div class="metric-value">$${formatNumber(analytics.total_revenue || 0)}</div><div class="metric-label">Total Revenue</div></div>
            <div class="metric-card"><div class="metric-value">${formatNumber(analytics.total_subscriptions || 0)}</div><div class="metric-label">Active Subscriptions</div></div>
            <div class="metric-card"><div class="metric-value">${formatNumber(analytics.new_users || 0)}</div><div class="metric-label">New Users</div></div>
            <div class="metric-card"><div class="metric-value">${formatNumber(analytics.api_calls || 0)}</div><div class="metric-label">API Calls</div></div>
        </div>
        <div class="api-response">
            <div class="response-header">
                <h3>API Response Data</h3>
                <span style="color: var(--accent-green); font-weight: 700; background: var(--bg-white); border: 1px solid var(--border-light); padding: 0.3rem 0.6rem; border-radius: 6px;">SUCCESS</span>
            </div>
            <div class="response-data">${JSON.stringify(currentData, null, 2)}</div>
        </div>
    `;
    contentDiv.innerHTML = html;
}
function displayError(error) {
    const contentDiv = document.getElementById('analytics-content');
    contentDiv.innerHTML = `
        <div class="error">
            <h3>Error Loading Analytics</h3>
            <p>${error}</p>
            <button class="btn" onclick="loadAnalytics()" style="margin-top: 0.5rem;">Try Again</button>
        </div>
    `;
}
function formatNumber(num) { if (num >= 1000000) { return (num / 1000000).toFixed(1) + 'M'; } else if (num >= 1000) { return (num / 1000).toFixed(1) + 'K'; } return Number(num).toLocaleString(); }

document.addEventListener('DOMContentLoaded', function() { loadAnalytics(); });
</script>
{% endblock %}