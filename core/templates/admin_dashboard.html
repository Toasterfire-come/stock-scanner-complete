<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Scanner Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        .navbar {
            background: rgba(31, 41, 55, 0.95);
            backdrop-filter: blur(10px);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .navbar h1 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
            background: linear-gradient(45deg, #60a5fa, #34d399);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .navbar a {
            color: white;
            margin-left: 1rem;
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        .navbar a:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        .status-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 2rem;
            margin-bottom: 2rem;
            transition: transform 0.3s ease;
        }
        .status-card:hover {
            transform: translateY(-2px);
        }
        .status-header {
            color: #1f2937;
            margin-bottom: 1.5rem;
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .status-header::before {
            content: "📊";
            font-size: 1.2rem;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .metric {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            border-left: 4px solid #2563eb;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .metric:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        .metric-label {
            font-size: 0.9rem;
            color: #6b7280;
            font-weight: 500;
        }
        .metric-success { 
            border-left-color: #10b981; 
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
        }
        .metric-warning { 
            border-left-color: #f59e0b; 
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }
        .metric-danger { 
            border-left-color: #ef4444; 
            background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
        }
        .btn-group {
            margin: 1rem 0;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        .log-container {
            background: rgba(31, 41, 55, 0.95);
            backdrop-filter: blur(10px);
            color: #e5e7eb;
            padding: 1.5rem;
            border-radius: 12px;
            height: 350px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            font-size: 0.9rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .log-container::-webkit-scrollbar {
            width: 8px;
        }
        .log-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        .log-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }
        .form-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 2rem;
        }
        .alert {
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin: 1rem 0;
            border: none;
        }
        .alert-success {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            color: #065f46;
            border-left: 4px solid #10b981;
        }
        .alert-danger {
            background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }
        .progress {
            height: 1.2rem;
            border-radius: 6px;
            overflow: hidden;
        }
        .progress-bar {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            transition: width 0.6s ease;
        }
        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        .status-online { background: #10b981; }
        .status-offline { background: #ef4444; }
        .status-warning { background: #f59e0b; }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>📊 Stock Scanner Admin</h1>
        <div>
            <a href="/">Home</a>
            <a href="/news/">News</a>
            <a href="/search/">Search</a>
            <a href="/filter/">Filter</a>
            <a href="/admin-dashboard/">Admin</a>
        </div>
    </div>

    <div class="container">
        <!-- System Status Overview -->
        <div class="status-card">
            <div class="status-header">System Status Overview</div>
            <div class="metrics-grid">
                <div class="metric metric-success">
                    <div class="metric-value" id="total-stocks">
                        <span class="loading-spinner"></span>
                    </div>
                    <div class="metric-label">Total Stocks</div>
                </div>
                <div class="metric" id="unsent-metric">
                    <div class="metric-value" id="unsent-notifications">
                        <span class="loading-spinner"></span>
                    </div>
                    <div class="metric-label">Unsent Notifications</div>
                </div>
                <div class="metric metric-success">
                    <div class="metric-value" id="success-rate">
                        <span class="loading-spinner"></span>
                    </div>
                    <div class="metric-label">Success Rate</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="last-update" style="font-size: 1.2rem;">
                        <span class="loading-spinner"></span>
                    </div>
                    <div class="metric-label">Last Update</div>
                </div>
                <div class="metric metric-success">
                    <div class="metric-value" id="system-status">
                        <span class="status-indicator status-online"></span>Online
                    </div>
                    <div class="metric-label">System Status</div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="status-card">
            <div class="status-header">⚡ Quick Actions</div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="runQuickTest()">
                    🧪 Quick Test (5 stocks)
                </button>
                <button class="btn btn-success" onclick="runWorkflow()">
                    🚀 Run Complete Workflow
                </button>
                <button class="btn btn-info" onclick="exportData()">
                    📤 Export Data
                </button>
                <button class="btn btn-warning" onclick="testNotifications()">
                    📧 Test Notifications
                </button>
                <button class="btn btn-secondary" onclick="refreshStatus()">
                    🔄 Refresh Status
                </button>
            </div>
        </div>

        <!-- Advanced Configuration -->
        <div class="form-section">
            <div class="status-header">⚙️ Advanced Configuration</div>
            <form id="configForm">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Batch Size</label>
                        <input type="number" class="form-control" id="batch-size" value="30" min="5" max="100">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Max Workers</label>
                        <input type="number" class="form-control" id="max-workers" value="3" min="1" max="10">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Delay Min (sec)</label>
                        <input type="number" step="0.1" class="form-control" id="delay-min" value="1.5" min="0.5" max="10">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Delay Max (sec)</label>
                        <input type="number" step="0.1" class="form-control" id="delay-max" value="3.5" min="1" max="20">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="use-cache" checked>
                            <label class="form-check-label" for="use-cache">
                                Enable Caching
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dry-run-notifications">
                            <label class="form-check-label" for="dry-run-notifications">
                                Dry Run (Test Mode)
                            </label>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-primary mt-3" onclick="runCustomWorkflow()">
                    🚀 Run Custom Workflow
                </button>
            </form>
        </div>

        <!-- Alternative API Status -->
        <div class="status-card">
            <div class="status-header">🔌 Alternative API Providers</div>
            <div id="api-providers">
                <div class="text-muted">Loading API provider status...</div>
            </div>
        </div>

        <!-- Real-time Logs -->
        <div class="status-card">
            <div class="status-header">📋 Real-time Execution Logs</div>
            <div class="log-container" id="logs">
                <div class="text-muted">Logs will appear here when operations are running...</div>
            </div>
            <button class="btn btn-outline-secondary btn-sm mt-2" onclick="clearLogs()">Clear Logs</button>
        </div>

        <!-- Progress Indicator -->
        <div id="progress-container" style="display: none;">
            <div class="status-card">
                <div class="status-header">⏳ Operation Progress</div>
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         id="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <div class="mt-2">
                    <small id="progress-text">Initializing...</small>
                </div>
            </div>
        </div>

        <!-- Alert Container -->
        <div id="alert-container"></div>
    </div>

    <script>
        // Global state
        let currentOperation = null;
        let logUpdateInterval = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            refreshStatus();
            loadApiProviders();
        });

        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alert-container');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alertDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        function showProgress(show = true) {
            document.getElementById('progress-container').style.display = show ? 'block' : 'none';
            if (!show) {
                document.getElementById('progress-bar').style.width = '0%';
            }
        }

        function updateProgress(percent, text) {
            document.getElementById('progress-bar').style.width = percent + '%';
            document.getElementById('progress-text').textContent = text;
        }

        function addLog(message) {
            const logsContainer = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span class="text-muted">[${timestamp}]</span> ${message}`;
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '<div class="text-muted">Logs cleared.</div>';
        }

        async function refreshStatus() {
            try {
                addLog('🔄 Refreshing system status...');
                const response = await fetch('/api/admin/status/');
                const data = await response.json();
                
                // Safe number formatting with null checks
                const totalStocks = data.total_stocks || 0;
                const unsentNotifications = data.unsent_notifications || 0;
                
                document.getElementById('total-stocks').textContent = totalStocks.toLocaleString();
                document.getElementById('unsent-notifications').textContent = unsentNotifications.toLocaleString();
                document.getElementById('success-rate').textContent = (data.success_rate || 0) + '%';
                document.getElementById('last-update').textContent = data.last_update || 'Never';
                
                // Update metric colors based on values
                const unsentMetric = document.getElementById('unsent-metric');
                if (data.unsent_notifications > 100) {
                    unsentMetric.className = 'metric metric-warning';
                } else if (data.unsent_notifications > 500) {
                    unsentMetric.className = 'metric metric-danger';
                } else {
                    unsentMetric.className = 'metric metric-success';
                }
                
                addLog('✅ Status refreshed successfully');
            } catch (error) {
                addLog('❌ Failed to refresh status: ' + error.message);
                showAlert('Failed to refresh status', 'danger');
            }
        }

        async function loadApiProviders() {
            try {
                const response = await fetch('/api/admin/api-providers/');
                const providers = await response.json();
                
                const container = document.getElementById('api-providers');
                container.innerHTML = '';
                
                Object.entries(providers).forEach(([name, status]) => {
                    const providerDiv = document.createElement('div');
                    providerDiv.className = 'metric ' + (status.configured ? 'metric-success' : 'metric-warning');
                    providerDiv.innerHTML = `
                        <strong>${name}</strong><br>
                        <small>${status.configured ? '✅ Configured' : '⚠️ Not configured'} - ${status.rate_limit}</small>
                    `;
                    container.appendChild(providerDiv);
                });
            } catch (error) {
                document.getElementById('api-providers').innerHTML = 
                    '<div class="text-danger">Failed to load API provider status</div>';
            }
        }

        async function executeCommand(command, params = {}) {
            showProgress(true);
            updateProgress(10, 'Initializing...');
            
            try {
                addLog(`🚀 Starting: ${command}`);
                const response = await fetch('/api/admin/execute/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command, params })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                updateProgress(50, 'Processing...');
                const result = await response.json();
                
                updateProgress(100, 'Completed');
                addLog(`✅ ${command} completed successfully`);
                addLog(`📊 Result: ${result.message}`);
                
                setTimeout(() => {
                    showProgress(false);
                    refreshStatus();
                }, 1000);
                
                showAlert(result.message, 'success');
                
            } catch (error) {
                updateProgress(100, 'Failed');
                addLog(`❌ ${command} failed: ${error.message}`);
                showAlert(`Operation failed: ${error.message}`, 'danger');
                setTimeout(() => showProgress(false), 2000);
            }
        }

        function runQuickTest() {
            executeCommand('quick_test', {
                batch_size: 5,
                max_workers: 1,
                use_cache: true,
                dry_run: true
            });
        }

        function runWorkflow() {
            executeCommand('workflow', {
                batch_size: parseInt(document.getElementById('batch-size').value),
                max_workers: parseInt(document.getElementById('max-workers').value),
                use_cache: document.getElementById('use-cache').checked,
                delay_range: [
                    parseFloat(document.getElementById('delay-min').value),
                    parseFloat(document.getElementById('delay-max').value)
                ]
            });
        }

        function runCustomWorkflow() {
            const params = {
                batch_size: parseInt(document.getElementById('batch-size').value),
                max_workers: parseInt(document.getElementById('max-workers').value),
                use_cache: document.getElementById('use-cache').checked,
                dry_run: document.getElementById('dry-run-notifications').checked,
                delay_range: [
                    parseFloat(document.getElementById('delay-min').value),
                    parseFloat(document.getElementById('delay-max').value)
                ]
            };
            executeCommand('custom_workflow', params);
        }

        function exportData() {
            executeCommand('export_data', { format: 'web' });
        }

        function testNotifications() {
            executeCommand('test_notifications', { dry_run: true });
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>