<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📊 Stock Scanner Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        .navbar {
            background: rgba(31, 41, 55, 0.95);
            backdrop-filter: blur(10px);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .navbar h1 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
            background: linear-gradient(45deg, #60a5fa, #34d399);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .navbar a {
            color: white;
            margin-left: 1rem;
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        .navbar a:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        .status-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 2rem;
            margin-bottom: 2rem;
            transition: transform 0.3s ease;
        }
        .status-card:hover {
            transform: translateY(-2px);
        }
        .status-header {
            color: #1f2937;
            margin-bottom: 1.5rem;
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .status-header i {
            color: #3b82f6;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .metric {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            border-left: 4px solid #2563eb;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .metric:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        .metric-label {
            font-size: 0.9rem;
            color: #6b7280;
            font-weight: 500;
        }
        .metric-success { 
            border-left-color: #10b981; 
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
        }
        .metric-warning { 
            border-left-color: #f59e0b; 
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }
        .metric-danger { 
            border-left-color: #ef4444; 
            background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
        }
        .btn-group {
            margin: 1rem 0;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        .log-container {
            background: rgba(31, 41, 55, 0.95);
            backdrop-filter: blur(10px);
            color: #e5e7eb;
            padding: 1.5rem;
            border-radius: 12px;
            height: 350px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            font-size: 0.9rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .log-container::-webkit-scrollbar {
            width: 8px;
        }
        .log-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        .log-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }
        .form-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 2rem;
        }
        .alert {
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin: 1rem 0;
            border: none;
        }
        .alert-success {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            color: #065f46;
            border-left: 4px solid #10b981;
        }
        .alert-danger {
            background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }
        .progress {
            height: 1.2rem;
            border-radius: 6px;
            overflow: hidden;
        }
        .progress-bar {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            transition: width 0.6s ease;
        }
        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        .status-online { background: #10b981; }
        .status-offline { background: #ef4444; }
        .status-warning { background: #f59e0b; }
        .news-item {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-left: 3px solid #3b82f6;
        }
        .news-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        .news-meta {
            font-size: 0.8rem;
            color: #6b7280;
        }
        .sentiment-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .sentiment-A { background: #d1fae5; color: #065f46; }
        .sentiment-B { background: #dbeafe; color: #1e40af; }
        .sentiment-C { background: #fef3c7; color: #92400e; }
        .sentiment-D { background: #fed7d7; color: #991b1b; }
        .sentiment-F { background: #fecaca; color: #991b1b; }
    </style>
</head>
<body>
    <div class="navbar">
        <h1><i class="fas fa-chart-line"></i> Stock Scanner Admin</h1>
        <div>
            <a href="/"><i class="fas fa-home"></i> Home</a>
            <a href="/news/"><i class="fas fa-newspaper"></i> News</a>
            <a href="/search/"><i class="fas fa-search"></i> Search</a>
            <a href="/filter/"><i class="fas fa-filter"></i> Filter</a>
            <a href="/admin/"><i class="fas fa-cog"></i> Django Admin</a>
        </div>
    </div>

    <div class="container">
        <!-- System Status Overview -->
        <div class="status-card">
            <div class="status-header">
                <i class="fas fa-tachometer-alt"></i>
                System Status Overview
                <button class="btn btn-sm btn-primary ms-auto" onclick="refreshStatus()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <div class="metrics-grid">
                <div class="metric metric-success">
                    <div class="metric-value" id="total-stocks">
                        <span class="loading-spinner"></span>
                    </div>
                    <div class="metric-label"><i class="fas fa-chart-bar"></i> Total Stocks</div>
                </div>
                <div class="metric" id="unsent-metric">
                    <div class="metric-value" id="unsent-notifications">
                        <span class="loading-spinner"></span>
                    </div>
                    <div class="metric-label"><i class="fas fa-bell"></i> Unsent Notifications</div>
                </div>
                <div class="metric metric-success">
                    <div class="metric-value" id="success-rate">
                        <span class="loading-spinner"></span>
                    </div>
                    <div class="metric-label"><i class="fas fa-check-circle"></i> Success Rate</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="last-update" style="font-size: 1.2rem;">
                        <span class="loading-spinner"></span>
                    </div>
                    <div class="metric-label"><i class="fas fa-clock"></i> Last Update</div>
                </div>
                <div class="metric metric-success">
                    <div class="metric-value" id="system-status">
                        <span class="status-indicator status-online"></span>Online
                    </div>
                    <div class="metric-label"><i class="fas fa-server"></i> System Status</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="total-news">
                        <span class="loading-spinner"></span>
                    </div>
                    <div class="metric-label"><i class="fas fa-newspaper"></i> News Articles</div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="status-card">
            <div class="status-header">
                <i class="fas fa-bolt"></i> Quick Actions
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="loadNasdaqData()">
                    <i class="fas fa-download"></i> Load NASDAQ Data
                </button>
                <button class="btn btn-success" onclick="updateStockData()">
                    <i class="fas fa-sync"></i> Update Stock Prices
                </button>
                <button class="btn btn-warning" onclick="scrapeNews()">
                    <i class="fas fa-newspaper"></i> Scrape News
                </button>
                <button class="btn btn-primary" onclick="sendNotifications()">
                    <i class="fas fa-paper-plane"></i> Send Notifications
                </button>
                <button class="btn btn-success" onclick="optimizeDatabase()">
                    <i class="fas fa-database"></i> Optimize Database
                </button>
            </div>
        </div>

        <!-- Recent News -->
        <div class="status-card">
            <div class="status-header">
                <i class="fas fa-newspaper"></i> Recent News
                <button class="btn btn-sm btn-primary ms-auto" onclick="refreshNews()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <div id="news-container">
                <div class="text-center">
                    <span class="loading-spinner"></span> Loading news...
                </div>
            </div>
        </div>

        <!-- System Logs -->
        <div class="status-card">
            <div class="status-header">
                <i class="fas fa-terminal"></i> System Logs
                <button class="btn btn-sm btn-warning ms-auto" onclick="clearLogs()">
                    <i class="fas fa-trash"></i> Clear
                </button>
            </div>
            <div class="log-container" id="log-container">
                <div>🚀 Stock Scanner Admin Dashboard initialized...</div>
                <div>📊 Waiting for system status...</div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced error handling and WordPress compatibility
        function safeNumber(value) {
            if (value === null || value === undefined || isNaN(value)) {
                return 0;
            }
            return Number(value);
        }

        function addLog(message) {
            const logContainer = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        async function refreshStatus() {
            try {
                addLog('🔄 Refreshing system status...');
                const response = await fetch('/api/admin/status/');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Safe number formatting with null checks
                const totalStocks = safeNumber(data.total_stocks);
                const unsentNotifications = safeNumber(data.unsent_notifications);
                const successRate = safeNumber(data.success_rate);
                const totalNews = safeNumber(data.total_news);
                
                document.getElementById('total-stocks').textContent = totalStocks.toLocaleString();
                document.getElementById('unsent-notifications').textContent = unsentNotifications.toLocaleString();
                document.getElementById('success-rate').textContent = successRate + '%';
                document.getElementById('last-update').textContent = data.last_update || 'Never';
                document.getElementById('total-news').textContent = totalNews.toLocaleString();
                
                // Update metric colors based on values
                const unsentMetric = document.getElementById('unsent-metric');
                if (unsentNotifications > 500) {
                    unsentMetric.className = 'metric metric-danger';
                } else if (unsentNotifications > 100) {
                    unsentMetric.className = 'metric metric-warning';
                } else {
                    unsentMetric.className = 'metric metric-success';
                }
                
                addLog(`✅ Status updated: ${totalStocks} stocks, ${unsentNotifications} pending notifications`);
                
            } catch (error) {
                addLog(`❌ Failed to refresh status: ${error.message}`);
                console.error('Status refresh error:', error);
                
                // Set fallback values
                document.getElementById('total-stocks').textContent = '0';
                document.getElementById('unsent-notifications').textContent = '0';
                document.getElementById('success-rate').textContent = '0%';
                document.getElementById('last-update').textContent = 'Error';
                document.getElementById('total-news').textContent = '0';
            }
        }

        async function refreshNews() {
            try {
                addLog('📰 Refreshing news...');
                const response = await fetch('/api/news/recent/');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const newsContainer = document.getElementById('news-container');
                
                if (data.articles && data.articles.length > 0) {
                    newsContainer.innerHTML = data.articles.map(article => `
                        <div class="news-item">
                            <div class="news-title">${article.headline || 'No title'}</div>
                            <div class="news-meta">
                                <span class="sentiment-badge sentiment-${article.sentiment_grade || 'N/A'}">
                                    ${article.sentiment_grade || 'N/A'}
                                </span>
                                ${article.published_date || 'Unknown date'}
                                ${article.mentioned_tickers ? '• Tickers: ' + article.mentioned_tickers.join(', ') : ''}
                            </div>
                        </div>
                    `).join('');
                } else {
                    newsContainer.innerHTML = '<div class="text-center text-muted">No recent news available</div>';
                }
                
                addLog(`✅ Loaded ${data.articles ? data.articles.length : 0} news articles`);
                
            } catch (error) {
                addLog(`❌ Failed to refresh news: ${error.message}`);
                document.getElementById('news-container').innerHTML = 
                    '<div class="text-center text-danger">Failed to load news</div>';
            }
        }

        async function executeCommand(command, endpoint, successMessage) {
            try {
                addLog(`🔄 ${command}...`);
                const response = await fetch(endpoint, { method: 'POST' });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                addLog(`✅ ${successMessage}: ${data.message || 'Success'}`);
                
                // Refresh status after command
                setTimeout(refreshStatus, 1000);
                
            } catch (error) {
                addLog(`❌ ${command} failed: ${error.message}`);
            }
        }

        // Command functions
        function loadNasdaqData() {
            executeCommand('Loading NASDAQ data', '/api/admin/load-nasdaq/', 'NASDAQ data loaded');
        }

        function updateStockData() {
            executeCommand('Updating stock data', '/api/admin/update-stocks/', 'Stock data updated');
        }

        function scrapeNews() {
            executeCommand('Scraping news', '/api/admin/scrape-news/', 'News scraped');
        }

        function sendNotifications() {
            executeCommand('Sending notifications', '/api/admin/send-notifications/', 'Notifications sent');
        }

        function optimizeDatabase() {
            executeCommand('Optimizing database', '/api/admin/optimize-db/', 'Database optimized');
        }

        function clearLogs() {
            document.getElementById('log-container').innerHTML = 
                '<div>🗑️ Logs cleared</div>';
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            addLog('🚀 Stock Scanner Admin Dashboard loaded');
            refreshStatus();
            refreshNews();
            
            // Auto-refresh every 30 seconds
            setInterval(refreshStatus, 30000);
            setInterval(refreshNews, 60000);
        });

        // WordPress compatibility - expose functions globally
        window.stockScannerAdmin = {
            refreshStatus,
            refreshNews,
            loadNasdaqData,
            updateStockData,
            scrapeNews,
            sendNotifications,
            optimizeDatabase,
            clearLogs
        };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>