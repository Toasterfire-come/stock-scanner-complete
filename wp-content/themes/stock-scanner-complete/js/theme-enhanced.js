/**
 * Stock Scanner Pro - Vanilla JS Enhancements (v6.1 - CSS Fixed)
 * Complete vanilla JavaScript functionality with traditional CSS loading
 */
(function(){
  'use strict';
  const qs=(s,r=document)=>r.querySelector(s); const qsa=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const on=(el,ev,fn)=>el&&el.addEventListener(ev,fn);
  const lockBody=(lock)=>{ document.documentElement.style.overflow = lock ? 'hidden' : ''; };

  function applyTheme(t){ document.documentElement.setAttribute('data-theme', t); localStorage.setItem('theme', t); }
  function initTheme(){ const saved=localStorage.getItem('theme'); if(saved){ applyTheme(saved);} else { try{ const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches; applyTheme(prefersDark?'dark':'light'); }catch(e){} } const btn=qs('[data-theme-toggle]'); on(btn,'click',()=>{ const cur=document.documentElement.getAttribute('data-theme')||'light'; applyTheme(cur==='light'?'dark':'light'); }); }
  function initMobileNav(){ const btn=qs('[data-mobile-menu-toggle]'); const nav=qs('.main-navigation'); if(!btn||!nav) return; on(btn,'click',()=>{ const ex=btn.getAttribute('aria-expanded')==='true'; btn.setAttribute('aria-expanded',String(!ex)); nav.classList.toggle('mobile-active'); lockBody(!ex); }); }
  function initUserMenu(){ const btn=qs('[data-user-menu-toggle]'); const menu=qs('[data-user-menu]'); if(!btn||!menu) return; on(btn,'click',(e)=>{ e.stopPropagation(); const show=!menu.classList.contains('show'); menu.classList.toggle('show',show); btn.setAttribute('aria-expanded',String(show)); }); on(document,'click',(e)=>{ if(!menu.contains(e.target)&&!btn.contains(e.target)){ menu.classList.remove('show'); btn.setAttribute('aria-expanded','false'); } }); }
  function initSearch(){ const openBtn=qs('[data-search-toggle]'); const overlay=qs('[data-search-overlay]'); const field=qs('#search-field'); if(!openBtn||!overlay) return; const closeBtn=qs('[data-search-close]'); const open=()=>{ overlay.setAttribute('aria-hidden','false'); overlay.classList.add('show'); lockBody(true); setTimeout(()=>field&&field.focus(),40); }; const close=()=>{ overlay.setAttribute('aria-hidden','true'); overlay.classList.remove('show'); lockBody(false); }; on(openBtn,'click',open); on(closeBtn,'click',close); on(document,'keydown',(e)=>{ if(e.key==='Escape') close(); }); const resultsWrap=qs('[data-search-results]'); const resultsContainer=resultsWrap?resultsWrap.querySelector('.results-container'):null; let t; on(field,'input',()=>{ const q=field.value.trim(); clearTimeout(t); if(!q){ resultsWrap&&(resultsWrap.style.display='none'); return; } t=setTimeout(async()=>{ try{ if(sessionStorage.getItem('ssp_srch_'+q)){ const rows=sessionStorage.getItem('ssp_srch_'+q); resultsWrap&&(resultsWrap.style.display=rows?'block':'none'); resultsContainer&&(resultsContainer.innerHTML=rows||'<div class="section-subtitle">No results</div>'); return; } const url=`${window.location.origin}/?s=${encodeURIComponent(q)}&post_type=post`; const res=await fetch(url,{headers:{'X-Requested-With':'fetch'}}); const html=await res.text(); const doc=new DOMParser().parseFromString(html,'text/html'); const items=qsa('.search-result, .archive-post, article',doc).slice(0,6); const rows=items.map(it=>{ const a=it.querySelector('a'); const title=a?a.textContent.trim():(it.querySelector('h2,h1')?.textContent.trim()||''); const href=a?a.href:'#'; return `<a class="user-menu-item" href="${href}">${title}</a>`; }).join(''); sessionStorage.setItem('ssp_srch_'+q, rows); resultsWrap&&(resultsWrap.style.display=rows?'block':'none'); resultsContainer&&(resultsContainer.innerHTML=rows||'<div class="section-subtitle">No results</div>'); }catch(e){} },250); }); }
  function initLoadingBar(){ const bar=qs('[data-loading-bar]'); if(!bar) return; const start=()=>{ bar.style.width='0'; bar.style.display='block'; requestAnimationFrame(()=> bar.style.width='60%'); }; const finish=()=>{ bar.style.width='100%'; setTimeout(()=>{ bar.style.display='none'; bar.style.width='0'; },300); }; on(document,'click',(e)=>{ const a=e.target.closest('a'); if(a&&a.href&&a.target!=='_blank'&&a.origin===location.origin&&!a.hash){ document.body.classList.add('page-fade-out'); start(); } }); on(window,'pageshow',()=>{ document.body.classList.remove('page-fade-out'); finish(); }); }
  function initShortcuts(){ let last=''; on(document,'keydown',(e)=>{ const tag=document.activeElement?.tagName?.toLowerCase(); const typing=tag==='input'||tag==='textarea'; if(e.key==='/'&&!e.metaKey&&!e.ctrlKey&&!e.altKey&&!e.shiftKey){ if(!typing){ e.preventDefault(); qs('[data-search-toggle]')?.click(); } return; } if(e.shiftKey&&e.key==='?'){ e.preventDefault(); openShortcutsOverlay(); return; } if(e.key.toLowerCase()==='t'&&!typing){ const cur=document.documentElement.getAttribute('data-theme')||'light'; applyTheme(cur==='light'?'dark':'light'); return; } if(e.key.toLowerCase()==='g'){ last='g'; setTimeout(()=>last='',700); return; } if(last==='g'&&e.key.toLowerCase()==='d'){ window.location.href='/dashboard/'; } if(last==='g'&&e.key.toLowerCase()==='h'){ window.location.href='/'; } }); }
  function initSmoothAnchors(){ on(document,'click',(e)=>{ const a=e.target.closest('a[href^="#"]'); if(!a||a.getAttribute('href')==='#') return; const id=a.getAttribute('href').slice(1); const t=document.getElementById(id); if(t){ e.preventDefault(); const header=qs('.site-header'); const off=(header?.offsetHeight||0)+10; const top=t.getBoundingClientRect().top+window.scrollY-off; window.scrollTo({top,behavior:'smooth'}); } }); }
  function initBackToTop(){ const btn=document.createElement('button'); btn.className='back-to-top'; btn.setAttribute('aria-label','Back to top'); btn.textContent='â†‘'; document.body.appendChild(btn); on(btn,'click',()=>window.scrollTo({top:0,behavior:'smooth'})); on(window,'scroll',()=>{ btn.classList.toggle('show', window.scrollY>600); }); }

  // Preferences with refined brand palettes
  function initPreferences(){ const d=localStorage.getItem('density'); const a=localStorage.getItem('accent'); if(d){ document.documentElement.setAttribute('data-density', d);} if(a){ document.documentElement.setAttribute('data-accent', a);} const overlay=document.createElement('div'); overlay.className='prefs-overlay'; overlay.innerHTML=`<div class=\"prefs-panel\"><div class=\"panel-body\"><h3 style=\"margin-bottom:.75rem\">Preferences</h3><div style=\"display:grid;gap:.75rem\"><div><label style=\"font-weight:600\">Density</label><div style=\"display:flex;gap:.5rem;margin-top:.25rem\"><button class=\"btn btn-sm\" data-density=\"comfortable\">Comfortable</button><button class=\"btn btn-sm\" data-density=\"compact\">Compact</button></div></div><div><label style=\"font-weight:600\">Accent</label><div style=\"display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.25rem\"><button class=\"btn btn-sm\" data-accent=\"blue\" style=\"background:linear-gradient(135deg,#667eea,#764ba2);color:#fff\">Blue</button><button class=\"btn btn-sm\" data-accent=\"emerald\" style=\"background:linear-gradient(135deg,#10b981,#059669);color:#fff\">Emerald</button><button class=\"btn btn-sm\" data-accent=\"amber\" style=\"background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff\">Amber</button><button class=\"btn btn-sm\" data-accent=\"violet\" style=\"background:linear-gradient(135deg,#8b5cf6,#6d28d9);color:#fff\">Violet</button><button class=\"btn btn-sm\" data-accent=\"indigo\" style=\"background:linear-gradient(135deg,#6366f1,#4338ca);color:#fff\">Indigo</button><button class=\"btn btn-sm\" data-accent=\"teal\" style=\"background:linear-gradient(135deg,#14b8a6,#0d9488);color:#fff\">Teal</button><button class=\"btn btn-sm\" data-accent=\"cyan\" style=\"background:linear-gradient(135deg,#06b6d4,#0891b2);color:#fff\">Cyan</button><button class=\"btn btn-sm\" data-accent=\"rose\" style=\"background:linear-gradient(135deg,#f43f5e,#be123c);color:#fff\">Rose</button><button class=\"btn btn-sm\" data-accent=\"slate\" style=\"background:linear-gradient(135deg,#64748b,#334155);color:#fff\">Slate</button><button class=\"btn btn-sm\" data-accent=\"orange\" style=\"background:linear-gradient(135deg,#f97316,#ea580c);color:#fff\">Orange</button><button class=\"btn btn-sm\" data-accent=\"fuchsia\" style=\"background:linear-gradient(135deg,#d946ef,#a21caf);color:#fff\">Fuchsia</button></div></div><div style=\"text-align:right\"><button class=\"btn btn-outline\" data-close-prefs>Close</button></div></div></div></div>`; document.body.appendChild(overlay); const open=()=>{ overlay.classList.add('show'); lockBody(true); }; const close=()=>{ overlay.classList.remove('show'); lockBody(false); };
    on(document,'click',(e)=>{ const den=e.target.closest('[data-density]'); if(den){ const val=den.getAttribute('data-density'); document.documentElement.setAttribute('data-density', val==='comfortable'?'':val); if(val==='comfortable') localStorage.removeItem('density'); else localStorage.setItem('density', val); } const ac=e.target.closest('[data-accent]'); if(ac){ const val=ac.getAttribute('data-accent'); const mapped=(val==='blue')?'':val; if(mapped) localStorage.setItem('accent', mapped); else localStorage.removeItem('accent'); document.documentElement.setAttribute('data-accent', mapped); } if(e.target.closest('[data-close-prefs]')||e.target===overlay){ close(); } }); const actions=qs('.header-actions'); const btn=document.createElement('button'); btn.className='btn btn-outline btn-sm'; btn.textContent='Preferences'; btn.type='button'; btn.style.marginLeft='.5rem'; on(btn,'click',open); if(actions){ actions.appendChild(btn);} else { document.body.appendChild(btn);} }

  function initLazyImages(){ qsa('img:not([loading])').forEach(img=>{ img.setAttribute('loading','lazy'); img.setAttribute('decoding','async'); }); }
  function initCopyButtons(){ qsa('pre').forEach(pre=>{ if(pre.querySelector('.copy-btn')) return; const b=document.createElement('button'); b.className='copy-btn'; b.textContent='Copy'; on(b,'click',()=>{ const code=pre.innerText; navigator.clipboard.writeText(code).then(()=>{ b.textContent='Copied!'; setTimeout(()=> b.textContent='Copy', 1200); }); }); pre.appendChild(b); }); }
  function initRipple(){ on(document,'click',(e)=>{ const b=e.target.closest('.btn'); if(!b) return; const rect=b.getBoundingClientRect(); const x=e.clientX-rect.left; const y=e.clientY-rect.top; const r=document.createElement('span'); r.className='ripple'; r.style.left=x+'px'; r.style.top=y+'px'; b.appendChild(r); setTimeout(()=>r.remove(), 600); }); }
  function initOfflineBanner(){ const bar=document.createElement('div'); bar.className='announce-bar'; bar.style.display='none'; bar.innerHTML='<span>ðŸ”Œ You are offline. Some features may not work.</span>'; document.body.prepend(bar); const update=()=>{ bar.style.display = navigator.onLine?'none':'flex'; }; window.addEventListener('online', update); window.addEventListener('offline', update); update(); }
  function hardenExternalLinks(){ on(document,'click',(e)=>{ const a=e.target.closest('a[href]'); if(!a) return; try{ const url=new URL(a.href); if(url.origin!==location.origin){ a.setAttribute('target','_blank'); a.setAttribute('rel','noopener'); } }catch(_e){} }); }
  function imageErrorFallback(){ const ph='data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="600" height="400"><defs><linearGradient id="g" x1="0" x2="1" y1="0" y2="1"><stop offset="0%" stop-color="#667eea"/><stop offset="100%" stop-color="#764ba2"/></linearGradient></defs><rect width="100%" height="100%" fill="url(#g)"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#fff" font-family="Arial" font-size="20">Image unavailable</text></svg>`); qsa('img').forEach(img=>{ img.addEventListener('error',()=>{ if(!img.dataset.fallback){ img.dataset.fallback='1'; img.src=ph; img.style.objectFit='cover'; } }); }); }

  // Pricing toggle logic (front-end)
  function initPricingToggle(){ const toggle = qs('[data-pricing-toggle]'); if(!toggle) return; const saved = localStorage.getItem('billing') || 'monthly'; document.documentElement.setAttribute('data-billing', saved); toggle.classList.toggle('active', saved==='annual'); function applyBilling(mode){ document.documentElement.setAttribute('data-billing', mode); localStorage.setItem('billing', mode); qsa('[data-price-monthly]').forEach(el=>{ const annual = el.getAttribute('data-price-annual'); const monthly = el.getAttribute('data-price-monthly'); el.textContent = (mode==='annual' && annual) ? annual : (monthly || el.textContent); }); qsa('a[data-cta]').forEach(a=>{ try{ const u=new URL(a.href, location.origin); u.searchParams.set('billing', mode); a.href=u.toString(); }catch(e){} }); } on(toggle,'click',()=>{ const cur = document.documentElement.getAttribute('data-billing')==='annual' ? 'monthly' : 'annual'; toggle.classList.toggle('active', cur==='annual'); applyBilling(cur); }); applyBilling(saved); }

  // Testimonials carousel for small/medium
  function initTestimonialsCarousel(){ const grid = qs('.testimonials-section .testimonials-grid'); if(!grid) return; const items = qsa('.testimonial-card', grid); if(items.length < 2) return; if(window.innerWidth > 900) return; const wrap = document.createElement('div'); wrap.className='carousel'; const track = document.createElement('div'); track.className='carousel-track'; items.forEach(card=>{ const slide=document.createElement('div'); slide.className='carousel-item'; slide.appendChild(card); track.appendChild(slide); }); wrap.appendChild(track); const dots=document.createElement('div'); dots.className='carousel-dots'; let index=0, auto; function renderDots(){ dots.innerHTML=''; for(let i=0;i<items.length;i++){ const d=document.createElement('button'); d.className='carousel-dot'+(i===index?' active':''); d.addEventListener('click',()=>{ index=i; update(); }); dots.appendChild(d);} } function update(){ track.style.transform = `translateX(-${index*100}%)`; renderDots(); } function start(){ stop(); auto=setInterval(()=>{ index=(index+1)%items.length; update(); }, 4500); } function stop(){ if(auto) clearInterval(auto); } wrap.appendChild(dots); grid.parentNode.replaceChild(wrap, grid); renderDots(); update(); start(); wrap.addEventListener('mouseenter', stop); wrap.addEventListener('mouseleave', start); }

  // Sticky CTA (safety)
  function initStickyCTA(){ let bar = qs('.sticky-cta'); if(!bar){ bar=document.createElement('div'); bar.className='sticky-cta'; bar.innerHTML='<span style="font-weight:600">Start 7â€‘Day Premium Trial for $1</span> <a href="/premium-plans/" class="btn btn-primary" data-cta>Get Started</a> <a href="/compare-plans/" class="btn btn-outline" data-cta>Compare</a>'; document.body.appendChild(bar); } const onScroll=()=>{ const sc=window.scrollY; const max=(document.documentElement.scrollHeight-document.documentElement.clientHeight)||1; bar.classList.toggle('show', (sc/max) > 0.35); }; window.addEventListener('scroll', onScroll); onScroll(); }

  function attachUTMToCTAs(){ const utm='utm_source=website&utm_medium=theme&utm_campaign=homepage'; qsa('[data-cta]').forEach(a=>{ try{ const u=new URL(a.href, location.origin); if(!u.search.includes('utm_')){ u.search += (u.search?'&':'') + utm; a.href=u.toString(); } }catch(e){} }); }

  function init(){ initTheme(); initMobileNav(); initUserMenu(); initSearch(); initLoadingBar(); initShortcuts(); initSmoothAnchors(); initBackToTop(); initPreferences(); initLazyImages(); initCopyButtons(); initRipple(); initOfflineBanner(); hardenExternalLinks(); imageErrorFallback(); initPricingToggle(); initTestimonialsCarousel(); initStickyCTA(); attachUTMToCTAs(); }

  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init);} else { init(); }

  function openShortcutsOverlay(){ let ov=qs('.shortcuts-overlay'); if(!ov){ ov=document.createElement('div'); ov.className='shortcuts-overlay'; ov.innerHTML=`<div class=\"shortcuts-panel\"><div class=\"panel-body\"><h3 style=\"margin-bottom:.5rem\">Keyboard Shortcuts</h3><ul style=\"list-style:none;padding:0;display:grid;gap:.25rem\"><li><strong>/</strong> Focus Search</li><li><strong>g</strong> then <strong>d</strong> Dashboard</li><li><strong>g</strong> then <strong>h</strong> Home</li><li><strong>Shift + ?</strong> Show this help</li><li><strong>t</strong> Toggle Theme</li><li><strong>Ctrl/Cmd + K</strong> Command Palette</li></ul><div style=\"text-align:right;margin-top:.75rem\"><button class=\"btn btn-outline\" data-close-shortcuts>Close</button></div></div></div>`; document.body.appendChild(ov);} ov.classList.add('show'); lockBody(true); const close=()=>{ ov.classList.remove('show'); lockBody(false); }; on(ov,'click',(e)=>{ if(e.target===ov||e.target.closest('[data-close-shortcuts]')) close(); }); on(document,'keydown',(e)=>{ if(e.key==='Escape') close(); }, { once:true }); }
})();