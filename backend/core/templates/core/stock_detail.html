{% extends 'base.html' %}
{% block title %}{{ title }}{% endblock %}
{% block head %}
  <script src="https://unpkg.com/lightweight-charts@4.2.4/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    .chart-wrap { display:grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 1100px) { .chart-wrap { grid-template-columns: 2fr 1fr; } }
    #chart { width: 100%; height: 440px; }
    #rsi { width: 100%; height: 140px; }
  </style>
{% endblock %}
{% block content %}
  <div class="card">
    <div class="card-header">
      <div class="card-title">{{ ticker }} â€¢ Interactive Chart</div>
      <div class="d-flex gap-2">
        <a href="/screeners/" class="btn">Back</a>
        <span class="badge">Daily</span>
      </div>
    </div>
    <div class="card-body">
      <div class="chart-wrap">
        <div class="chart-panel">
          <div class="chart-title">
            <h2>Price</h2>
            <div class="chart-legend">
              <span><span class="legend-dot" style="background:#4f7cff"></span> SMA20</span>
              <span><span class="legend-dot" style="background:#22d3ee"></span> EMA50</span>
            </div>
          </div>
          <div class="grid" style="margin-bottom:8px;">
            <div class="btn-group" role="group" aria-label="Intervals">
              <button class="btn" data-interval="1d">1D</button>
              <button class="btn" data-interval="1w">1W</button>
              <button class="btn" data-interval="1m">1M</button>
              <button class="btn" data-interval="6mo">6M</button>
              <button class="btn" data-interval="1y">1Y</button>
            </div>
            <div class="btn-group" role="group" aria-label="Presets">
              <button class="btn" data-preset="day">Day Trader</button>
              <button class="btn" data-preset="swing">Swing</button>
              <button class="btn" data-preset="invest">Investor</button>
            </div>
            <button id="exportPng" class="btn">Export PNG</button>
            <button id="createAlert" class="btn primary">Create alert</button>
          </div>
          <div id="chart"></div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">Overview</div></div>
          <div class="card-body">
            <div class="grid">
              <div class="kpi"><div class="label">Ticker</div><div class="value">{{ ticker }}</div></div>
              <div class="kpi"><div class="label">Exchange</div><div class="value">NASDAQ</div></div>
              <div class="kpi"><div class="label">Status</div><div class="value">Active</div></div>
            </div>
          </div>
          <div class="hr"></div>
          <div class="card-header"><div class="card-title">RSI(14)</div></div>
          <div class="card-body"><div id="rsi"></div></div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
{% block scripts %}
  <script>
    const ticker = "{{ ticker }}";
  </script>
  <script>
    (async function() {
      async function fetchData(period = '6mo', interval = '1d', indicators = 'sma20,ema50,rsi14') {
        const url = `/api/stocks/${ticker}/ohlc/?period=${period}&interval=${interval}&indicators=${indicators}`;
        const res = await fetch(url);
        return await res.json();
      }
      let data = await fetchData();
      if (!data.success) return;

      const ohlc = data.ohlc.map(o => ({ time: o.t / 1000, open: o.o, high: o.h, low: o.l, close: o.c }));

      const priceChart = LightweightCharts.createChart(document.getElementById('chart'), {
        layout: { background: { type: 'solid', color: 'transparent' }, textColor: getComputedStyle(document.documentElement).getPropertyValue('--text').trim() },
        grid: { vertLines: { color: 'rgba(255,255,255,0.05)' }, horzLines: { color: 'rgba(255,255,255,0.05)' } },
        rightPriceScale: { borderVisible: false },
        timeScale: { borderVisible: false },
        crosshair: { mode: LightweightCharts.CrosshairMode.Magnet },
      });
      const candleSeries = priceChart.addCandlestickSeries({ upColor: '#1fbf75', downColor: '#f44336', borderVisible: false, wickUpColor: '#1fbf75', wickDownColor: '#f44336' });
      candleSeries.setData(ohlc);

      const sma20 = data.indicators.sma20 || [];
      const ema50 = data.indicators.ema50 || [];
      const sma20Series = priceChart.addLineSeries({ color: '#4f7cff', lineWidth: 2 });
      const ema50Series = priceChart.addLineSeries({ color: '#22d3ee', lineWidth: 2 });
      function renderOverlays() {
        sma20Series.setData(ohlc.map((d, i) => ({ time: d.time, value: sma20[i] ?? null })).filter(p => p.value !== null));
        ema50Series.setData(ohlc.map((d, i) => ({ time: d.time, value: ema50[i] ?? null })).filter(p => p.value !== null));
      }
      renderOverlays();

      const rsiChart = LightweightCharts.createChart(document.getElementById('rsi'), {
        layout: { background: { type: 'solid', color: 'transparent' }, textColor: getComputedStyle(document.documentElement).getPropertyValue('--text').trim() },
        rightPriceScale: { borderVisible: false },
        timeScale: { borderVisible: false },
        grid: { vertLines: { color: 'rgba(255,255,255,0.05)' }, horzLines: { color: 'rgba(255,255,255,0.05)' } },
      });
      const rsiSeries = rsiChart.addLineSeries({ color: '#f59e0b', lineWidth: 2 });
      function renderRsi() {
        const rsi = data.indicators.rsi14 || [];
        rsiSeries.setData(ohlc.map((d, i) => ({ time: d.time, value: rsi[i] ?? null })).filter(p => p.value !== null));
      }
      renderRsi();

      // Controls: interval chips
      document.querySelectorAll('[data-interval]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const choice = btn.getAttribute('data-interval');
          const map = { '1d': ['1mo','1h'], '1w': ['3mo','1h'], '1m': ['6mo','1d'], '6mo': ['6mo','1d'], '1y': ['1y','1d'] };
          const [period, interval] = map[choice] || ['6mo','1d'];
          data = await fetchData(period, interval);
          const newOhlc = data.ohlc.map(o => ({ time: o.t / 1000, open: o.o, high: o.h, low: o.l, close: o.c }));
          ohlc.length = 0; ohlc.push(...newOhlc);
          candleSeries.setData(ohlc);
          sma20 = data.indicators.sma20 || [];
          ema50 = data.indicators.ema50 || [];
          renderOverlays();
          renderRsi();
        });
      });

      // Presets
      document.querySelectorAll('[data-preset]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const preset = btn.getAttribute('data-preset');
          let inds = 'sma20,ema50,rsi14';
          if (preset === 'day') inds = 'ema10,ema20,rsi14';
          if (preset === 'swing') inds = 'sma20,ema50,rsi14';
          if (preset === 'invest') inds = 'sma50,sma200,rsi14';
          data = await fetchData('6mo','1d', inds);
          const newOhlc = data.ohlc.map(o => ({ time: o.t / 1000, open: o.o, high: o.h, low: o.l, close: o.c }));
          ohlc.length = 0; ohlc.push(...newOhlc);
          candleSeries.setData(ohlc);
          sma20 = data.indicators.sma20 || [];
          ema50 = data.indicators.ema50 || [];
          renderOverlays();
          renderRsi();
        });
      });

      // Export PNG
      document.getElementById('exportPng').addEventListener('click', async () => {
        const canvas = document.querySelector('#chart canvas');
        if (!canvas) return;
        const url = canvas.toDataURL('image/png');
        const a = document.createElement('a');
        a.href = url; a.download = `${ticker}.png`; a.click();
      });

      // Create Alert (client-side modal prompt)
      document.getElementById('createAlert').addEventListener('click', () => {
        window.openCreateAlert?.({ ticker });
      });
    })();
  </script>
{% endblock %}
